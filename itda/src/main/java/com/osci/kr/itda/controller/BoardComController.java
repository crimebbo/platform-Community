package com.osci.kr.itda.controller;import com.osci.kr.itda.common.controller.ItDaBaseController;import com.osci.kr.itda.common.exception.ItDaExceptionHandler;import com.osci.kr.itda.common.model.ItDaResult;import com.osci.kr.itda.entity.Board;import com.osci.kr.itda.entity.BoardComment;import com.osci.kr.itda.entity.CommentFileupload;import com.osci.kr.itda.entity.FileUpload;import com.osci.kr.itda.repo.CommentFileuploadReop;import com.osci.kr.itda.serviceimpl.BoardComServiceImpl;import com.osci.kr.itda.serviceimpl.BoardServiceImpl;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.core.io.InputStreamResource;import org.springframework.core.io.UrlResource;import org.springframework.core.io.support.ResourceRegion;import org.springframework.http.*;import org.springframework.web.bind.annotation.*;import org.springframework.web.multipart.MultipartFile;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import javax.validation.Valid;import java.io.File;import java.io.FileInputStream;import java.io.FileNotFoundException;import java.io.IOException;import java.util.Collections;import java.util.List;import java.util.Optional;import static org.springframework.hateoas.server.mvc.WebMvcLinkBuilder.linkTo;@CrossOrigin(origins = "*" ,allowedHeaders = "*")@RestController@RequestMapping("/rest/api/v1/board/comment")public class BoardComController extends ItDaBaseController {    private final Logger logger = LoggerFactory.getLogger(this.getClass());    @Autowired    private BoardComServiceImpl boardComService;    @Autowired    private CommentFileuploadReop commentFileuploadReop;    /**     * 댓글  작성     * @return     * @throws ItDaExceptionHandler     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @PostMapping(value = "/write", produces = { MediaType.APPLICATION_JSON_VALUE })    public ResponseEntity<ItDaResult> write(@Valid @RequestBody BoardComment comment,                                            HttpServletRequest req  , HttpServletResponse res) throws ItDaExceptionHandler {        ItDaResult result = new ItDaResult();        try{            result = boardComService.write(comment,req,res);            comment.add(linkTo(UserController.class).withSelfRel());            result.setResultMsg("SUCCESS");            result.setResultCode(201);        }catch (Exception e){            result.setResultCode(400);            result.setResultMsg("fail Reason ::::: " + e.getMessage());        }        return new ResponseEntity<ItDaResult>(result, HttpStatus.CREATED);    }    /**     * 댓글  수정     * @return     * @throws ItDaExceptionHandler     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @PostMapping(value = "/modify", produces = { MediaType.APPLICATION_JSON_VALUE })    public  ResponseEntity<ItDaResult> modify(@Valid @RequestBody BoardComment comment,                                              HttpServletRequest req  , HttpServletResponse res) throws ItDaExceptionHandler {        ItDaResult result = new ItDaResult();        try{            boardComService.modify(comment,req,res);            result.setResultCode(201);            result.setResultMsg("SUCCESS");        }catch (Exception e){            result.setResultCode(400);            result.setErrorCode(e.getMessage());            result.setResultMsg("fail Reason ::::: " + e.getMessage());        }        return new ResponseEntity<ItDaResult>(result, HttpStatus.CREATED);    }    /**     * 댓글  삭제     * @return     * @throws ItDaExceptionHandler     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @DeleteMapping(value = "/delete/{cmtid}", produces = { MediaType.APPLICATION_JSON_VALUE })    public  ResponseEntity<ItDaResult> delete(@PathVariable(value = "cmtid") Long cmtid) throws ItDaExceptionHandler {        ItDaResult result = new ItDaResult();        try{            boardComService.commDelete(cmtid);            result.setResultCode(200);            result.setResultMsg("SUCCESS");        }catch (Exception e){            result.setResultCode(400);            result.setErrorCode(e.getMessage());            result.setResultMsg("fail Reason ::::: " + e.getMessage());        }        return new ResponseEntity<ItDaResult>(result, HttpStatus.CREATED);    }    /**     * 좋아요     * @param cmtid     * @return     * @throws ItDaExceptionHandler     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @GetMapping(value = "/like/{cmtid}/{userid}", produces = { MediaType.APPLICATION_JSON_VALUE })    public  ResponseEntity<ItDaResult> like(@PathVariable(value = "cmtid") Long cmtid,                                            @PathVariable(value = "userid") String userid) throws ItDaExceptionHandler {        ItDaResult result = new ItDaResult();        try{            result = boardComService.likeConut(cmtid,userid);            result.setResultCode(201);            result.setResultMsg("SUCCESS");        }catch (Exception e){            result.setResultCode(400);            result.setErrorCode(e.getMessage());            result.setResultMsg("fail Reason ::::: " + e.getMessage());        }        return new ResponseEntity<ItDaResult>(result, HttpStatus.CREATED);    }    /**     * unlike     * @param cmtid     * @return     * @throws ItDaExceptionHandler     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @GetMapping(value = "/unlike/{cmtid}/{userid}", produces = { MediaType.APPLICATION_JSON_VALUE })    public  ResponseEntity<ItDaResult> unlike(@PathVariable(value = "cmtid") Long cmtid,                                              @PathVariable(value = "userid") String userid) throws ItDaExceptionHandler {        ItDaResult result = new ItDaResult();        try{            result = boardComService.unlikeCount(cmtid,userid);            result.setResultCode(201);            result.setResultMsg("SUCCESS");        }catch (Exception e){            result.setResultCode(400);            result.setErrorCode(e.getMessage());            result.setResultMsg("fail Reason ::::: " + e.getMessage());        }        return new ResponseEntity<ItDaResult>(result, HttpStatus.CREATED);    }    /**     * 파일 업로드     * @return     * @throws ItDaExceptionHandler     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @PostMapping(value = "/file/upload/{cmtid}", produces = { MediaType.APPLICATION_JSON_VALUE })    public  ResponseEntity<ItDaResult> fileupload(@RequestParam("file") MultipartFile multipartFile,                                                  @PathVariable(value = "cmtid") Long cmtid,                                                  HttpServletRequest req ,HttpServletResponse res ) throws ItDaExceptionHandler {        ItDaResult result = new ItDaResult();        try{            result = boardComService.fileupload(multipartFile,cmtid,req,res);            result.setResultCode(200);            result.setResultMsg("SUCCESS");        }catch (Exception e){            result.setResultCode(400);            result.setErrorCode(e.getMessage());            result.setResultMsg("fail Reason ::::: " + e.getMessage());        }        return new ResponseEntity<ItDaResult>(result, HttpStatus.CREATED);    }    /**     * 첨부파일 다운로드     * @return     * @throws ItDaExceptionHandler     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @GetMapping(value = "/file/download/{fileid}", produces = { MediaType.APPLICATION_JSON_VALUE })    public ResponseEntity<InputStreamResource> downloadFile(@PathVariable(value = "fileid") Long fileid,                                                            HttpServletRequest req , HttpServletResponse res) throws FileNotFoundException,ItDaExceptionHandler {        Optional<CommentFileupload> downFile = commentFileuploadReop.findById(fileid);        CommentFileupload fileInfo= downFile.get();        File file = new File(fileInfo.getFilePath());        String filename = fileInfo.getOriginname();        InputStreamResource resource = new InputStreamResource(new FileInputStream(file));        HttpHeaders header = new HttpHeaders();        header.add(HttpHeaders.CONTENT_DISPOSITION, "attachment; filename="+filename);        header.add("Cache-Control", "no-cache, no-store, must-revalidate");        header.add("Pragma", "no-cache");        header.add("Expires", "0");        return ResponseEntity.ok()                .headers(header)                .contentLength(file.length())                .contentType(MediaType.parseMediaType("application/octet-stream"))                .body(resource);    }    /**     * 동영상 파일 스트리밍     * @param fileid     * @param headers     * @return     * @throws IOException     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @GetMapping(value = "/file/video/{fileid}", produces = { MediaType.APPLICATION_JSON_VALUE })    public ResponseEntity<ResourceRegion> getVideo(@PathVariable Long fileid, @RequestHeader HttpHeaders headers) throws IOException {        logger.info("getVideo");        Optional<CommentFileupload> downFile = commentFileuploadReop.findById(fileid);        CommentFileupload fileInfo= downFile.get();        UrlResource video = new UrlResource("classpath:/static/KakaoTalk_Video_2021-02-10-10-55-07.mp4");        List<HttpRange> range = Collections.singletonList(HttpRange.createByteRange(0, 1000000000));        headers.setRange(range);        ResourceRegion region = resourceRegion(video, headers);        return ResponseEntity.status(HttpStatus.PARTIAL_CONTENT)                .contentType(MediaTypeFactory.getMediaType(video)                        .orElse(MediaType.APPLICATION_OCTET_STREAM))                .body(region);    }    /**     * 첨부파일 삭제     * @return     * @throws ItDaExceptionHandler     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @DeleteMapping(value = "/file/remove/{fileid}", produces = { MediaType.APPLICATION_JSON_VALUE })    public  ResponseEntity<ItDaResult> fileupload(@PathVariable(value = "fileid") Long fileid,                                                  HttpServletRequest req ,HttpServletResponse res ) throws ItDaExceptionHandler {        ItDaResult result = new ItDaResult();        try{            boardComService.fileRemove(fileid,req,res);            result.setResultCode(200);            result.setResultMsg("SUCCESS");        }catch (Exception e){            result.setResultCode(400);            result.setErrorCode(e.getMessage());            result.setResultMsg("fail Reason ::::: " + e.getMessage());        }        return new ResponseEntity<ItDaResult>(result, HttpStatus.CREATED);    }    /**     * 댓글  단건 조회     * @return     * @throws ItDaExceptionHandler     */    @CrossOrigin(origins = "*" ,allowedHeaders = "*")    @GetMapping(value = "/selectOne/{userid}/{cmtid}", produces = { MediaType.APPLICATION_JSON_VALUE })    public  ResponseEntity<ItDaResult> selectOne(@PathVariable(value = "userid") String userid,                                                 @PathVariable(value = "cmtid") Long cmtid) throws ItDaExceptionHandler {        ItDaResult result = new ItDaResult();        try{            result =boardComService.selectOne(userid,cmtid);            result.setResultMsg("SUCCESS");        }catch (Exception e){            result.setResultCode(400);            result.setErrorCode(e.getMessage());            result.setResultMsg("fail Reason ::::: " + e.getMessage());        }        return new ResponseEntity<ItDaResult>(result, HttpStatus.CREATED);    }    private ResourceRegion resourceRegion(UrlResource video, HttpHeaders headers) throws IOException {        final long chunkSize = 1000000L;        long contentLength = video.contentLength();        HttpRange httpRange = headers.getRange().stream().findFirst().get();        if(httpRange != null) {            long start = httpRange.getRangeStart(contentLength);            long end = httpRange.getRangeEnd(contentLength);            long rangeLength = Long.min(chunkSize, end - start + 1);            return new ResourceRegion(video, start, rangeLength);        } else {            long rangeLength = Long.min(chunkSize, contentLength);            return new ResourceRegion(video, 0, rangeLength);        }    }}